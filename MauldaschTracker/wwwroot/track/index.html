<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        <script type="application/javascript">
            window.addEventListener("load", async () => {
                try {
                    const search = new URLSearchParams(window.location.search.substring(1));
                    const item = search.get('id');

                    document.getElementById('multi-tracking-link').setAttribute('href', `/track/multi.html?ids=${item}`);

                    const apiParams = new URLSearchParams();
                    apiParams.append("item", item);

                    const response = await fetch(`/api/Item/Track?${apiParams}`);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }

                    const itemData = await response.json();

                    document.getElementById('itemid').innerText = itemData.item.id;
                    document.getElementById('owner').innerText = itemData.item.owner;
                    document.getElementById('name').innerText = itemData.item.name;
                    document.getElementById('description').innerText = itemData.item.description;

                    const table = document.createElement('table');
                    table.setAttribute('border', '1');
                    table.setAttribute('cellpadding', '5');

                    for (const pos of itemData.resultItems)
                    {
                        const row = table.insertRow();
                        
                        let cell = row.insertCell();
                        cell.innerText = new Date(pos.time).toLocaleString();
                        
                        cell = row.insertCell();
                        cell.innerText = pos.collection;
                        
                        cell = row.insertCell();
                        if (pos.latitude != null && pos.longitude != null)
                        {
                            let link = document.createElement('a');
                            link.setAttribute('target', '_blank')
                            link.setAttribute('href', `https://www.openstreetmap.org/?mlat=${pos.latitude}&mlon=${pos.longitude}#map=11/${pos.latitude}/${pos.longitude}`);
                            link.innerText = `${pos.latitude} ${pos.longitude} ${pos.accuracy != null ? `(${pos.accuracy.toFixed(0)}m)` : ''}`;
                            cell.appendChild(link);
                        }
                    }

                    document.getElementById('locations').replaceChildren(table);


                    const currentPosition = itemData.resultItems.find(x => x.latitude != null && x.longitude != null);
                    const mapElem = document.getElementById('map');
                    const map = L.map(mapElem);
                    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    if (currentPosition != null)
                    {
                        var target = L.latLng(currentPosition.latitude, currentPosition.longitude);

                        map.setView(target, 10);

                        L.marker(target).addTo(map);
                    }

                    var trackingPoints = itemData.resultItems
                        .filter(x => x.latitude != null && x.longitude != null)
                        .map(x => [x.latitude, x.longitude]);            
  
                    var polyline = L.polyline(trackingPoints).addTo(map);

                } catch (error) {
                    alert('Des glomp isch hee:\n' + error);
                }
            });
        </script>

        <style>
        </style>
    </head>
    <body>
        <a id="multi-tracking-link">Zum Multi-Glump-Tracking</a>
        <h2>Glomp</h2>
        <table border="1" cellpadding="5">
            <tr>
                <td>Nommer</td>
                <td id="itemid">Jetz wart </td>
            </tr>
            <tr>
                <td>Was isches</td>
                <td id="name">halt amol</td>
            </tr>
            <tr>
                <td>Was isches genau?</td>
                <td id="description">bisses fertig</td>
            </tr>
            <tr>
                <td>Wem g'h√∂rts</td>
                <td id="owner">g'lade hot</td>
            </tr>
        </table>
        <div id="map" style="width: 640px; height: 480px; margin: 10px 0;"></div>
        <h2>Wo war's un wo isches</h2>
        <div id="locations"></div>
    </body>
</html>